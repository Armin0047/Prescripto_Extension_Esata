(()=>{"use strict";function e(){const e=document.querySelector("link[href*='bootstrap']"),t=document.querySelector("script[src*='bootstrap']");if(!e){const e=document.createElement("link");e.rel="stylesheet",e.href=chrome.runtime.getURL("assets/css/bootstrap.min.css"),document.head.appendChild(e)}if(!t){const e=document.createElement("script");e.src=chrome.runtime.getURL("assets/js/bootstrap.bundle.min.js"),e.defer=!0,document.head.appendChild(e)}}function t(e){return String(e).replace(/,/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,",")}function n(e,t,n){return 0===parseInt(n)&&parseInt(t)<parseInt(e)}function a(e,t){return parseFloat(t)<parseFloat(e)}async function d(e,t,n,a){const d=`${e.API_URL}api/esata/UpdateKala?codeKala=${t}&CodeKalaNew=${n}&erxCode=${encodeURIComponent(a)}`,r=await fetch(d,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!r.ok)throw new Error("ثبت کالای پیش‌فرض ناموفق بود");return await r.json()}async function r(e,r,i=1,o="",l,s,c){const m=await async function(e,t,n=1,a=50,d=""){const r=`${e.API_URL}api/Pharmcy/GetProducts?Codesazeman=${t}&page=${n}&size=${a}&search=${encodeURIComponent(d)}`,i=await fetch(r,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!i.ok)throw new Error("دریافت محصولات از API ناموفق بود");return await i.json()}(e,r,i,50,o);document.getElementById("productTableBody").innerHTML="",function(e,r,i,o,l){const s=document.getElementById("productTableBody");r.forEach((r,c)=>{const m=document.createElement("tr");m.innerHTML=`\n      <td id="trbtn${c}"></td>\n      <td id="trcode${c}">${r.code}</td>\n      <td id="trfaname${c}">${r.faname}</td>\n      <td id="trenname${c}">${r.enname}</td>\n      <td id="trgencode${c}">${r.gencode}</td>\n      <td id="trprice${c}">${t(r.price||"0")}</td>\n      <td id="trmojodi${c}">${r.mojodi??""}</td>\n      <td id="trmojodianb${c}">${r.mojodiAnb??""}</td>`,s.appendChild(m);const h=document.createElement("button");h.textContent="انتخاب",h.classList.add("btn","btn-sm","btn-success"),h.id=`btnselectKala${c}`,document.getElementById(`trbtn${c}`).appendChild(h),h.addEventListener("click",()=>async function(e,r,i,o,l){const s=document.getElementById(`trcode${r}`).innerText.trim(),c=document.getElementById(`trfaname${r}`).innerText.trim(),m=document.getElementById(`trgencode${r}`).innerText.trim(),h=document.getElementById(`trprice${r}`).innerText.replace(/,/g,""),p=document.getElementById(`trmojodi${r}`).innerText.trim()||"0",g=document.getElementById(`datascodeKalaAria${i}`),u=document.getElementById(`datasnameAria${i}`),b=document.getElementById(`datasgencodeAria${i}`),y=document.getElementById(`dataspriceAria${i}`),f=document.getElementById(`datasmojodiAria${i}`),v=document.getElementById(`tdbtnted${i}`),x=document.getElementById(`datastotalAmount${i}`);document.getElementById(`datasgencode${i}`),n(v.value,p,o)?f.style.color="red":f.style.color="blue";const E=parseFloat(h)*parseInt(v.value),I=parseFloat(x.innerText.replace(/,/g,""));y.style.background=a(I,E)?"#f0f06c":"transparent","0"===g.innerText?confirm("آیا داروی انتخابی را به عنوان پیش‌فرض ژنریک ذخیره می‌کنید؟")&&await d(e,g.innerText,s,l):g.innerText&&g.innerText===s||parseInt(m.toString())!==parseInt(b.innerText.toString())||confirm("آیا داروی انتخابی را به عنوان پیش‌فرض ژنریک ذخیره می‌کنید؟")&&await d(e,g.innerText,s,l),u.innerText=c,b.innerText=m,y.innerText=t(h),f.innerText=p,g.innerText=s,document.getElementById("InsertDr")?.remove(),document.getElementById("modalBackdropDr")?.remove()}(e,c,i,o,l))})}(e,m.data,l,s,c)}let i=[],o=[],l=0,s=0,c=0;function m(d){e();const m=document.getElementById("floating-button");m.disabled=!0,o={Server:d.Server,DataBase:d.DataBase,username:d.username,pass:d.pass,API_URL:d.APIURL};const h=document.createElement("div");h.id="mainModalOverlay",h.style="\n                position:fixed;\n                top:0; left:0;\n                width:100%; height:100vh;\n                background:rgba(0, 0, 0, 0.6);\n                backdrop-filter:blur(4px);\n                z-index:9998;";const p=document.createElement("div");p.id="mainModalBox",p.style="\n            position: fixed;\n            top: 2%;\n            left: 50%;\n            transform: translateX(-50%);\n            max-height: 95vh; /* محدود کردن ارتفاع مدال */\n            overflow-y: auto; /* فعال‌سازی اسکرول داخل مدال */\n            width: 95vw;\n            background: linear-gradient(135deg, #ffffff, #f2f2f2);\n            padding: 30px;\n            border-radius: 12px;\n            box-shadow: 0 20px 40px rgba(0,0,0,0.3);\n            z-index: 9999;\n            font-family: 'Vazirmatn', sans-serif;\n            ";const g=document.createElement("button");g.innerText="❌",g.setAttribute("id","closeBtnManager"),g.classList.add("btn","btn-sm","btn-light"),g.style="position:absolute;\n            top:15px; right:15px;\n            background:#eee;\n            border-radius:20%;\n            width:32px;\n            display:flex; align-items:center; justify-content:center;\n            font-size:18px;\n            cursor:pointer;\n            transition:background 0.3s;",g.addEventListener("click",()=>{m.disabled=!1,h.remove(),p.remove()});const u=document.createElement("div");u.innerHTML=function(e){const t=document.getElementById("floating-button");t.textContent="📤 ارسال اطلاعات به نرم‌افزار آریا",t.style.backgroundColor="#4dc473",document.createElement("div");let n="<div Class='table-responsive scroll-container'> <table style='width:100%;border-collapse:separate; border-spacing:0; margin-bottom:20px; background:#fafafa; box-shadow:0 2px 6px rgba(0,0,0,0.05); border-radius:8px; overflow:hidden;border: 1px solid black;border-collapse: collapse;' class='table table-striped table-bordered'><thead style='text-align: center;'><tr><th scope='col' colspan='10' style='background:rgb(209, 207, 207)'>اطلاعات سایت  نیروهای مسلح</th><th scope='col' colspan='7' style='background-color:rgb(213, 227, 242)'>اطلاعات نرم افزار آریا</th></tr><tr><th>دستور مصرف</th><th>سهم بیمار</th><th>سهم سازمان</th><th>مجموع</th><th>قیمت تعهد</th><th>قیمت واحد</th><th>تعداد</th><th>نام</th><th>ERXCode</th><th>کدژنریک / IRC</th><th class='widthCell'>تعداد تحویلی</th><th>موجودی</th><th>قیمت</th><th>نام</th><th>کدژنریک</th><th>کدکالا</th><th class='widthCell'>انتخاب</th></tr></thead><tbody id='RdfKala'>";return n+="</tbody></table></div>",`\n        <div Class="form-group">\n        <div style="text-align: center;">\n        <h2>نرم افزار اتوماسیون داروخانه آریا</h2>\n        </div>\n        <div Class="form-control">\n                            <table style="\n                            width:100%;\n                            top=10px;\n                            border-collapse:separate;\n                            border-spacing:0;\n                            margin-bottom:20px;\n                            background:#fafafa;\n                            box-shadow:0 2px 6px rgba(0,0,0,0.05);\n                            border-radius:8px;\n                            overflow:hidden;" dir="rtl">\n                            <tbody id="tbodyFacheder">\n                            <tr style="background:#05f7ab;">\n                            <td colspan="2" style="padding:10px; font-weight:bold;">${e.CoName}</td>\n                            <td style="padding:10px; font-weight:bold;">سرور :</td>\n                            <td style="padding:10px; font-weight:bold;">${e.Hname}</td>\n                            <td style="padding:10px; font-weight:bold;">کاربر :</td>\n                            <td style="padding:10px; font-weight:bold;">${e.Lname}</td>\n                            <td style="padding:10px; font-weight:bold;">فروش منفی :</td>\n                            <td style="padding:10px; font-weight:bold;">${1===e.isManfi?"مجاز":"غیر مجاز"}</td>\n                            </tr>\n                            <tr>                           \n                            <td style="padding:10px; font-weight:bold;">کدرهگیری تجویز :</td>\n                            <td style="padding:10px;">${e.ReqNum}</td>                    \n                            <td style="padding:10px; font-weight:bold;">کد ملی :</td>\n                            <td style="padding:10px;">${e.NationalCode.replace("- کد ملی : ","")}</td>\n                            <td style="padding:10px; font-weight:bold;">نظام پزشک :</td>\n                            <td style="padding:10px;">${e.NezamDr}</td>\n                            <td style="padding:10px; font-weight:bold;">مبلغ کل :</td>\n                            <td style="padding:10px;" id="jamkolnoskhe">${e.jamkol}</td>\n                            </tr>\n                            <tr style="background:#f2f2f2;">\n                            <td style="padding:10px; font-weight:bold;">تاریخ ثبت :</td>\n                            <td style="padding:10px;" id="lbltdDateFac">${e.DateNoskhe.toString().substring(0,4)}/${e.DateNoskhe.toString().substring(4,6)}/${e.DateNoskhe.toString().substring(6,8)}</td>                    \n                            <td style="padding:10px; font-weight:bold;">نام بیمار : </td>\n                            <td style="padding:10px;"><input type="text" class="form-control" id="lblBimarName" Placeholder="نام بیمار را وارد کنید..." value="${e.bimarname.replace("- ","")}"></td>\n                            <td style="padding:10px; font-weight:bold;">پزشک آریا :</td>\n                            <td style="padding:10px;"><label id="lblNameDrAria">${e.NameDrAria}</label></td>\n                            <td style="padding:10px; font-weight:bold;">سهم سازمان :</td>\n                            <td style="padding:10px;" id="hedersahmsazeman">${e.Sahmsazemanvalue}</td>\n                            </tr>\n                            <tr>\n                            <td style="padding:10px; font-weight:bold;">تاریخ نسخه :</td>\n                            <td style="padding:10px;" id="lbltdDateNoskhe" >${e.DateNoskhe.toString().substring(0,4)}/${e.DateNoskhe.toString().substring(4,6)}/${e.DateNoskhe.toString().substring(6,8)}</td>                    \n                            <td style="padding:10px; font-weight:bold;">موبایل :</td>\n                            <td style="padding:10px;"><input type="text" class="form-control" id="lblMobileName" Placeholder="موبایل بیمار را وارد کنید..."></td>\n                            <td style="padding:10px; font-weight:bold;">تخصص آریا :</td>\n                            <td style="padding:10px;"><label id="lblTakhasosName">${e.Takhasos}</label></td>\n                            <td style="padding:10px; font-weight:bold; color:red;">سهم بیمار :</td>\n                            <td style="padding:10px; color:red;" id="hedersahmbimar">${e.SahmBimar}</td>\n                            </tr>\n                            </tr>\n                            <tr style="background:#f2f2f2;">\n                            <td style="padding:10px; font-weight:bold; color:red;">کدرهگیری ارائه :</td>\n                            <td style="padding:10px; color:red;">${e.trackingCode}</td>                                        \n                            <td style="padding:10px; font-weight:bold;">سازمان :</td>\n                            <td style="padding:10px;"><select id="ListSazeman" name="ListSazeman" class="form-select"></select></td>\n                            <td style="padding:10px; font-weight:bold;">تعریف پزشک :</td>\n                            <td style="padding:10px;"><input id="btnInserDr" type="button" value="تعریف پزشک" class="btn btn-warning"></td>\n                            <td style="padding:10px; font-weight:bold; color:red;"></td>\n                            <td style="padding:10px; color:red;"></td>\n                            </tr>\n                        </tbody>\n                        </table>\n        </div>                \n                        <h6 class="text-muted" dir="rtl">ردیف‌ها:</h6>   \n                         <div Class='table-responsive scroll-container'> <table style='width:100%;border-collapse:separate; border-spacing:0; margin-bottom:20px; background:#fafafa; box-shadow:0 2px 6px rgba(0,0,0,0.05); border-radius:8px; overflow:hidden;border: 1px solid black;border-collapse: collapse;' class='table table-striped table-bordered'><thead style='text-align: center;'><tr><th scope='col' colspan='10' style='background:rgb(209, 207, 207)'>اطلاعات سایت  نیروهای مسلح</th><th scope='col' colspan='7' style='background-color:rgb(213, 227, 242)'>اطلاعات نرم افزار آریا</th></tr><tr><th>دستور مصرف</th><th>سهم بیمار</th><th>سهم سازمان</th><th>مجموع</th><th>قیمت تعهد</th><th>قیمت واحد</th><th>تعداد</th><th>نام</th><th>ERXCode</th><th>کدژنریک / IRC</th><th class='widthCell'>تعداد تحویلی</th><th>موجودی</th><th>قیمت</th><th>نام</th><th>کدژنریک</th><th>کدکالا</th><th class='widthCell'>انتخاب</th></tr></thead><tbody id='RdfKala'></tbody></table></div>                                  \n                        \n        </div>\n        <footer>\n        <div Class="form-control">\n                        <div calss=""row>\n                            <div dir="rtl">\n                            <label style="color:red;direction:rtl;">نکته : اگر جمع قیمت کالا انتخابی شما از جمع سایت نیروهای مسلح کمتر شود اطلاعات قیمت سایت  نیروهای مسلح برای آن ردیف لحاظ میگردد</label>\n                            </div>\n                            <div dir="rtl">\n                            <label style="color:red;direction:rtl;">نکته : اگر جمع قیمت کالا انتخابی شما از جمع سایت  نیروهای مسلح بیشتر شود اختلاف قیمت در اضافه مبلغ آن ردیف لحاظ میگردد</label>\n                            </div>\n                        </div>\n                        <div class="main"> \n                            <hr />\n                            <div class="row">                                \n                                <div dir="rtl" class="col-lg-9">                        \n                                    <P style="font-size:0.9rem;"><span>شماره نسخه : </span><span id="sh_noskhe">0</span><span id="txtsh_noskhe"></span></P> \n                                    <P style="font-size:0.9rem;margin-top:-10px;"><span>مبلغ قابل پرداخت : </span><span id="jamkolpardakht">0</span><span>&nbsp&nbspريال&nbsp&nbsp</span></P>\n                                </div>  \n                                <div class="col-lg-3">         \n                                    <input id="InsertNoskheInAria" type="submit" value="ثبت نسخه" Class="btn btn-success pull-left">  \n                                </div>                              \n                            </div> \n                        </div>\n            </div>\n                        \n                        \n        </footer>\n        `}(d),p.appendChild(g),p.appendChild(u),document.body.appendChild(h),document.body.appendChild(p);const b=document.getElementById("RdfKala");b.innerHTML="",d.Radifs.forEach((e,i)=>{const m=document.createElement("tr");m.innerHTML=`\n          <td id="datasorgShare${i}" class="dirrtl">${e.orgShare}</td>\n          <td id="dataspaymentByPatient${i}">${""===e.paymentByPatient?0:t(e.paymentByPatient)}</td>\n          <td id="dataspaymentByOrg${i}">${""===e.paymentByOrg?0:t(e.paymentByOrg)}</td>\n          <td id="datastotalAmount${i}">${""===e.totalAmount?0:t(e.totalAmount)}</td>\n          <td id="dataspricebimeh${i}">${t(e.priceBimeh)}</td>\n          <td id="datasprice${i}">${t(e.price)}</td>\n          <td id="datastedUsage${i}">${e.tedUsage}</td>\n          <td id="datadrugName${i}">${e.drugName}</td>\n          <td id="dataserxcode${i}">${e.erxCode}</td>\n          <td id="datasgencode${i}">${e.gencode}</td>\n          <td id="datastedUsage${i}" class="widthCell"><input type="number" id="tdbtnted${i}" class="widthCell" value="${e.tedUsage}"/></td>\n          <td id="datasmojodiAria${i}">${e.mojodiAria}</td>\n          <td id="dataspriceAria${i}">${e.priceAria}</td>\n          <td id="datasnameAria${i}">${e.nameAria}</td>\n          <td id="datasgencodeAria${i}">${e.gencodeAria}</td>\n          <td id="datascodeKalaAria${i}">${e.codeKalaAria}</td>\n          <td id="datascodeKalaAria${i}"><button id="btnAddKala${i}" type="button" style="color:white" class="btn btn-info widthbtn">ویرایش</button></td>\n          `,b.appendChild(m),l+=parseFloat(""===e.totalAmount?0:e.totalAmount),s+=parseFloat(""===e.paymentByPatient?0:e.paymentByPatient),c+=parseFloat(""===e.paymentByOrg?0:e.paymentByOrg),document.getElementById("datasmojodiAria"+i).style.color=n(e.tedUsage.replace(/,/g,""),e.mojodiAria,d.isManfi)?"rgb(250, 5, 5)":"rgb(68, 68, 242)";const h=document.getElementById(`dataspriceAria${i}`),p=parseFloat(e.tedUsage)*parseInt(e.priceAria),g=parseFloat(e.totalAmount.replace(/,/g,""));h.style.background=a(g,p)?"#f0f06c":"transparent";const u=document.getElementById("tdbtnted"+i);u.addEventListener("blur",function(){""===u.value&&(u.value=e.tedUsage)});const y=document.getElementById("btnAddKala"+i);y?y.addEventListener("click",function(){const t=document.getElementById("ListSazeman").selectedIndex,n=document.getElementById("ListSazeman").options[t];!async function(e,t,n,a,d,i,o){const l=document.createElement("div");l.id="modalBackdropDr",l.style="\n      position: fixed; top: 0; left: 0;\n      width: 100vw; height: 100vh;\n      background: rgba(0,0,0,0.5);\n      overflow-y: auto;\n      display: flex; justify-content: center; align-items: center; direction: rtl;\n      z-index: 9999;";const s=document.createElement("div");s.id="InsertDr",s.style="\n      background: white;\n      max-height: 90vh;\n      padding: 20px;\n      border-radius: 8px;\n      top: 10%;\n      width: 80vw;\n      box-shadow: 0 0 20px rgba(0,0,0,0.3);";const c=document.createElement("div");c.style.height="80vh",c.innerHTML=`\n      <div class="card">\n        <div class="card-header">\n          <small class="form-text text-muted">جستجو کالا</small>\n          <p style="font-size:1rem">\n            <span>دارو تجویزی: </span><span>${t} - </span><span>${o} - </span><span>${n}</span>\n          </p>\n        </div>\n        <div class="form-group row">\n          <small class="col-sm-1 col-form-label" style="margin-right:1rem;margin-top:0.5rem;margin-bottom:0.5rem;">جستجو</small>\n          <div class="col-sm-10">\n            <input style="margin-top:0.5rem" class="form-control" type="text" name="SName" value="${t}" placeholder="برای جستجو تایپ کنید..." />\n          </div>\n        </div>\n      </div>\n      <div class="modal-body" style="margin-top:1rem;">\n        <div class="table-responsive">\n          <table class="table table-bordered table-hover">\n            <thead class="thead-light" >\n              <tr>\n                <th>انتخاب</th><th>کد کالا</th><th>نام فارسی</th><th>نام لاتین</th><th>کدژنریک</th><th>قیمت</th><th>موجودی قفسه</th><th>موجودی انبار</th>\n              </tr>\n            </thead>\n            <tbody id="productTableBody">\n            </tbody>\n          </table>\n        </div>\n  </div>`;const m=document.createElement("button");let h;m.id="btnCloseModalDr",m.textContent="بستن",m.classList.add("btn","btn-secondary"),m.style="margin-top: 10px; float: left;",s.appendChild(c),s.appendChild(m),l.appendChild(s),document.body.appendChild(l),m.addEventListener("click",function(){l.remove()}),l.addEventListener("click",function(e){s.contains(e.target)||e.stopPropagation()}),r(e,a,1,t,d,i,o),document.querySelector('input[name="SName"]').addEventListener("input",function(){clearTimeout(h);const t=this.value.trim();h=setTimeout(()=>{r(e,a,1,t,d,i,o)},300)})}(o,e.gencode,e.drugName,n.value,i,d.isManfi,e.erxCode)}):console.log("دکمه پیدا نشد")}),document.getElementById("jamkolnoskhe").innerHTML=t(l),document.getElementById("hedersahmbimar").innerHTML=t(s),document.getElementById("hedersahmsazeman").innerHTML=t(c),async function(e){const t=await async function(e){const t=await fetch(`${e.API_URL}api/esata/GetSazeman`,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!t.ok)throw new Error("ارتباط با API سازمان‌ها ناموفق بود");return await t.json()}(e);let n=[];t.data.forEach(e=>{n={Codesazeman:e.codeSazeman,NameSazeman:e.nameSazeman},i.push(n)}),i.forEach(e=>{const t=document.getElementById("ListSazeman"),n=document.createElement("option");n.textContent=e.NameSazeman,n.value=e.Codesazeman,t.appendChild(n)})}(o),document.getElementById("InsertNoskheInAria").addEventListener("click",function(){const e=document.getElementById("lblNameDrAria");"-"!==e.innerHTML&&e.innerHTML?async function(e,a){const d=document.getElementById("InsertNoskheInAria"),r=document.getElementById("closeBtnManager");d.disabled=!0,r.disabled=!0;let i=1,o=1;const m=document.getElementById("RdfKala").querySelectorAll("tr");if(m.forEach((e,t)=>{const n=document.getElementById("datascodeKalaAria"+t);0!==parseInt(n.innerHTML)&&n.innerText||1===o&&(o=0)}),1!==parseInt(a.isManfi)&&1===parseInt(o)&&m.forEach((e,t)=>{const d=document.getElementById("datasmojodiAria"+t);n(document.getElementById("tdbtnted"+t).value,d.innerText,a.isManfi)&&1===i&&(i=0)}),1===parseInt(i)&&1===parseInt(o)){const n=[];m.forEach((e,t)=>{const a=e.querySelectorAll("td"),d=document.getElementById("tdbtnted"+t);n.push({orgShare:a[0].innerText.trim(),paymentByPatient:a[1].innerText.trim(),paymentByOrg:a[2].innerText.trim(),totalAmount:a[3].innerText.trim(),priceBimeh:a[4].innerText.trim().toString().replace(/,/g,""),price:a[5].innerText.trim().toString().replace(/,/g,""),tedUsage:d.value,PriceAria:a[12].innerText.trim(),CodeKalaAria:a[15].innerText.trim()})});const i=document.getElementById("lbltdDateFac"),o=document.getElementById("lbltdDateNoskhe"),h=document.getElementById("lblMobileName"),p=document.getElementById("lblBimarName"),g=document.getElementById("ListSazeman").selectedIndex,u=document.getElementById("ListSazeman").options[g],b={ReqNum:a.ReqNum.toString().trim(),RegDate:i.innerText.trim(),ReqDate:o.innerText.trim(),TotalAmount:l.toString(),PaymentByOrg:c.toString(),PaymentByPatient:s.toString(),NationalCode:a.NationalCode,DocID:a.NezamDr,codetakh:a.codetakh,codetakh2:a.codetakhsend2,mobile:h.value,bimarname:p.value,Codesazeman:u.value,trackingcode:a.trackingCode.toString(),Radifs:n};console.log(b);const y=await async function(e,t){const n=await fetch(`${e.API_URL}api/esata/InsertFactor`,{method:"POST",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass,"Content-Type":"application/json"},body:JSON.stringify(t)});return await n.json()}(e,b);if(y.data.sh_noskhe>0){const e=y.data.jamkolpardakht,n=document.getElementById("sh_noskhe");n.innerHTML="&nbsp&nbsp"+y.data.sh_noskhe+"&nbsp&nbsp",n.style.background="rgb(59, 150, 77)";const a=document.getElementById("txtsh_noskhe");a.innerHTML="&nbsp&nbsp&nbspثبت نسخه با موفقیت انجام شد&nbsp&nbsp&nbsp",a.style.color="rgb(59, 150, 77)",document.getElementById("jamkolpardakht").innerHTML="&nbsp&nbsp"+t(e)+"&nbsp&nbsp",alert("✅ نسخه شما با موفقیت در نرم افزار ثبت شد ✅ \n شماره نسخه : "+y.data.sh_noskhe+" \n مبلغ قابل پرداخت : "+t(e)+" ريال "),r.disabled=!1,console.log("%c  developer by : %cdamavandiarmin@gmail.com  ","color: red; font-weight: bold; background-color: #f5e8c4","color: green;background-color: #f5e8c4")}else alert("⚠️ خطا ناشناخته : "+y.statusmessage),console.log("%c  developer by : %cdamavandiarmin@gmail.com  ","color: red; font-weight: bold; background-color: #f5e8c4","color: green;background-color: #f5e8c4"),d.disabled=!1,r.disabled=!1}else 0===parseInt(o)?alert("❌ برخی از اقلام هنوز  به کالا آریا متصل نشده اند ❌"):0===parseInt(i)&&alert("❌ موجودی برخی اقلام منفی میباشد ❌"),d.disabled=!1,r.disabled=!1}(o,d):alert("❌ ابتدا پزشک را تعریف کنید ❌")}),document.getElementById("btnInserDr").addEventListener("click",function(){"-"===document.getElementById("lblNameDrAria").innerText&&async function(e,t){const n=document.createElement("div");n.id="modalBackdropDr",n.style="\n    position: fixed;\n    top: 0; left: 0;\n    width: 100vw; height: 100vh;\n    background: rgba(0,0,0,0.5);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    direction: rtl;\n    z-index: 9999;";const a=document.createElement("div");a.id="InsertDr",a.style="\n    background: white;\n    padding: 25px;\n    border-radius: 10px;\n    width: 50vw;\n    box-shadow: 0 0 20px rgba(0,0,0,0.3);";const d=document.createElement("div");d.innerHTML='\n    <h5>تعریف پزشک</h5>\n    <div class="form-group">\n      <label>نام پزشک:</label>\n      <input type="text" id="inputnameDr" class="form-control" />\n    </div>\n    <div class="form-group mt-3">\n      <label>تخصص پزشک:</label>\n      <select id="selectTakh" class="form-select">\n        <option value="0" disabled selected>انتخاب تخصص</option>\n      </select>\n    </div>\n    <div class="form-group mt-4">\n      <button class="btn btn-success" id="btnInsideModalDr">ثبت و ذخیره</button>\n      <button class="btn btn-secondary" id="btnCloseModalDr">بستن</button>\n    </div>',a.appendChild(d),n.appendChild(a),document.body.appendChild(n),document.getElementById("btnCloseModalDr").addEventListener("click",()=>{n.remove()});try{const t=await async function(e){const t=await fetch(`${e.API_URL}api/Pharmcy/GetTakhasos`,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!t.ok)throw new Error("ارتباط با API تخصص‌ها ناموفق بود");return await t.json()}(e);if(t.success){const e=document.getElementById("selectTakh");t.data.forEach(({codeTakh:t,takhasosName:n})=>{const a=document.createElement("option");a.value=t,a.textContent=n,e.appendChild(a)})}}catch(e){console.error("❌ خطا در دریافت تخصص‌ها:",e.message)}document.getElementById("btnInsideModalDr").addEventListener("click",async()=>{const a=document.getElementById("inputnameDr").value.trim(),d=document.getElementById("selectTakh"),r=d.options[d.selectedIndex];if(!a)return alert("لطفاً نام پزشک را وارد کنید");if(!r||!r.value||0===parseInt(r.value))return alert("لطفاً تخصص را انتخاب کنید");try{const d=await async function(e,t,n,a){const d=`${e.API_URL}api/Pharmcy/InsertDr?Codedr=${t}&NameDr=${n}&codetakh=${a}`,r=await fetch(d,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!r.ok)throw new Error("ثبت پزشک در API ناموفق بود");return await r.json()}(e,t,a,r.value);d.success?(document.getElementById("lblNameDrAria").innerText=a,document.getElementById("lblTakhasosName").innerText=r.text,window.codetakhsend=r.value,window.codetakhsend2=d.data.codetakh2,n.remove()):alert("❌ خطا: "+d.message)}catch(e){console.error("❌ خطا در ثبت پزشک:",e.message)}})}(o,d.NezamDr)})}let h,p=0,g=0,u=0,b=0,y=0,f=0,v=0,x=0,E="",I="";e(),function(){const e=document.createElement("button");e.id="floating-button",e.textContent="📤 ارسال اطلاعات به نرم‌افزار آریا",Object.assign(e.style,{position:"fixed",top:"75px",right:"80vw",zIndex:"9999",backgroundColor:"#4dc473",color:"white",padding:"10px 15px",border:"none",borderRadius:"8px",cursor:"pointer"}),document.body.appendChild(e),console.log("%c  developer by : %cdamavandiarmin@gmail.com  ","color: red; font-weight: bold; background-color: #f5e8c4","color: green;background-color: #f5e8c4"),e.addEventListener("click",async()=>{e.disabled=!0;try{if(h=document.querySelector("presentation-trackingcode-dialog"),x=document.querySelector("presentation-medicine.ng-star-inserted"),x||(x=document.querySelector("paper-medicine.ng-star-inserted")),!h)return alert("❌ نسخه ای پیدا نشد"),e.disabled=!1;!async function(){const e=document.createElement("div");e.id="modalBackdropDr",e.style="\n    position: fixed;\n    top: 0; left: 0;\n    width: 100vw; height: 100vh;\n    background: rgba(0,0,0,0.5);\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    direction: rtl;\n    z-index: 9999;";const n=document.createElement("div");n.id="InsertDr",n.style="\n    background: white;\n    padding: 25px;\n    border-radius: 10px;\n    width: 30vw;\n    box-shadow: 0 0 20px rgba(0,0,0,0.3);";const a=document.createElement("div");a.setAttribute("class","card"),a.innerHTML='\n    <div class="card-header text-center" style="background:rgb(212, 206, 205);">\n        <h5>ورود به نرم افزار</h5>\n    </div>\n    <div class="container">\n    </form>\n    <form>\n        <div class="row">\n                <div class="col-10">\n                    <label>نام کاربری</label><br>      \n                    <input type="text" name="uidaria" autocomplete="off" id="uidaria" class="form-control" value="" spellcheck="false" placeholder="نام کاربری"/>\n                </div> \n                <div class="col-2">            \n                </div>      \n        </div>\n        <div class="w-100"></div>\n        <div class="row">\n                <div class="col-10">\n                    <label>رمز عبور</label><br>            \n                    <input type="text" name="pidaria" autocomplete="off" id="pidaria" class="form-control" value="" spellcheck="false" placeholder="رمز عبور"/>\n                </div> \n                <div class="col-2">            \n                </div>      \n        </div>\n        <div class="w-100"></div>\n        <div class="row">\n                <div class="col-10">\n                    <label>نام سرور</label><br>            \n                    <input type="text" dir="ltr" name="servernamearia"  id="servernamearia" class="form-control text-center" disabled/>\n                </div> \n                <div class="col-2">            \n                </div>      \n        </div>\n        <div class="w-100"></div>\n        <div class="row">\n                <div class="col-10">\n                    <label>پایگاه داده</label><br>            \n                    <input type="text" name="databasenamearia" id="databasenamearia" class="form-control text-center" disabled/>\n                </div> \n                <div class="col-2">            \n                </div>      \n        </div>\n        <div class="w-100"></div><br>\n    </form>    \n    </div> \n    <div class="card-footer">   \n        <div class="row"  style=" position: relative;">\n            <div class="col-md-4">\n            </div>\n            <div class="col-md-4">\n            <button class="btn btn-success" id="btnInsideModalDr" style="height:auto;width:100%;top: 0%;bottom: 0%;margin:0;pading:0;">ورود</button>\n            </div>\n            <div class="col-md-4">\n            <button class="btn btn-secondary" id="btnCloseModalDr" style="height:auto;width:100%;top: 0%;bottom: 0%;margin:0;pading:0;">خروج</button>\n            </div>\n        </div>        \n    </div>',n.appendChild(a),e.appendChild(n),document.body.appendChild(e),document.getElementById("btnCloseModalDr").addEventListener("click",()=>{e.remove()}),document.getElementById("btnInsideModalDr").addEventListener("click",async()=>{const n=document.getElementById("btnCloseModalDr"),a=document.getElementById("btnInsideModalDr");if(n.disabled=!0,a.disabled=!0,null!==document.getElementById("uidaria").value&&document.getElementById("uidaria").value){if(w.username=I,w.pass=E,w.Server=document.getElementById("servernamearia").value,w.DataBase=document.getElementById("databasenamearia").value,k=await async function(e){try{const t=await fetch(`${e.API_URL}api/Pharmcy/GetName`,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}}),n=await t.json();return n.success,await n}catch(e){return await new Error("❌ Network or parsing error:",e.message)}}(w),k.success){const n=document.getElementById("floating-button");n.textContent="در حال واکشی اطلاعات... لطفا کمی صبر کنید",n.style.backgroundColor="#945916",n.disabled=!0,u=k.data.valMojodi,b=k.data.id,y=k.data.lname,f=k.data.hname,v=k.data.coName,e.remove(),await async function(e){let n,a,d,r,i,o,l;const s=document.getElementById("layoutContent");if(n=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[6]?.children[1].innerText,a=s.children[1]?.children[1]?.children[0]?.children[0]?.children[0]?.children[3].innerText.toString().replace("- کد ملی : ","").trim(),d=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[3]?.children[1].innerText,r=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[4]?.children[1].innerText.toString().replace(/-/g,"").trim(),i=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[4]?.children[1].innerText.toString().replace(/-/g,"").trim(),o=s.children[1]?.children[1]?.children[0]?.children[0]?.children[0]?.children[2].innerText,l=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[0]?.children[1]?.children[0].innerText,!r){a=s.children[1]?.children[1]?.children[0]?.children[0]?.children[0]?.children[3].innerText.toString().replace("- کد ملی : ","").trim(),d=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[2]?.children[1].innerText,r=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[3]?.children[1].innerText.toString().replace(/-/g,"").trim(),i=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[1]?.children[0]?.children[1]?.children[0]?.children[0]?.children[3]?.children[1].innerText.toString().replace(/-/g,"").trim(),o=s.children[1]?.children[1]?.children[0]?.children[0]?.children[0]?.children[2].innerText,l=s.children[1]?.children[1]?.children[0]?.children[0]?.children[1]?.children[0]?.children[1]?.children[0].innerText;const e=l?.trim().split(" - ");n=e[1]}const c=function(){const e=[];let t;try{t=x.children[0].children[1].children[1].children[0].children[0].children[0].children[0].children[1]}catch{t=x.children[1].children[1].children[1].children[0].children[0].children[0].children[0].children[1]}const n=t?.getElementsByTagName("tr")||[];return[].slice.call(n).forEach(t=>{const n=t.getElementsByTagName("td");12===n.length?e.push({gencode:n[2].innerText.toString().replace("...","").trim()??"",drugName:n[3].innerText.trim()??"",tedUsage:n[4].innerText.trim()??0,tedTahod:n[5].innerText.trim()??0,orgShare:n[6].innerText.trim()??"",price:n[7].children[1].children[0].children[0].children[0].value.toString().replace(/,/g,"").trim()??0,byOrg:n[8].innerText.toString().replace(/,/g,"").trim()??0,paymentByOrg:n[9].innerText.toString().replace(/,/g,"").trim()??0,paymentByPatient:n[10].innerText.toString().replace(/,/g,"").trim()??0,totalAmount:n[11].innerText.toString().replace(/,/g,"").trim()??0}):e.push({gencode:n[2].innerText.toString().replace("...","").trim()??"",drugName:n[3].innerText.trim()??"",tedUsage:n[5].innerText.trim()??0,tedTahod:n[6].innerText.trim()??0,orgShare:n[7].innerText.trim()??"",price:n[8].children[1].children[0].children[0].children[0].value.toString().replace(/,/g,"").trim()??0,byOrg:n[9].innerText.toString().replace(/,/g,"").trim()??0,paymentByOrg:n[10].innerText.toString().replace(/,/g,"").trim()??0,paymentByPatient:n[11].innerText.toString().replace(/,/g,"").trim()??0,totalAmount:n[12].innerText.toString().replace(/,/g,"").trim()??0})}),e}(),E=h.children[0].children[0].children[0].children[1].children[0].children[0].children[0].children[1].innerHTML,I=await async function(e,t,n,a){const d=`${e.API_URL}api/esata/GetExsitsNoskhe?codepigiri=${t}&ShDaftarcheh=${n}&DateFac=${a}`,r=await fetch(d,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!r.ok)throw new Error("ارتباط با API بررسی نسخه ناموفق بود");return await r.json()}(e,E,a,r);if(I.data.sh_noskhe>0){alert("❌ این نسخه قبلاً ثبت شده است ❌\n شماره نسخه : "+I.data.sh_noskhe+"\n قابل پرداخت : "+t(I.data.jamkolpardakht)+" ريال");const e=document.getElementById("floating-button");return e.textContent="📤 ارسال اطلاعات به نرم‌افزار آریا",e.style.backgroundColor="#4dc473",e.disabled=!1}const w=await async function(e,t){const n=`${e.API_URL}api/Pharmcy/GetNameDr?DocID=${t}`,a=await fetch(n,{method:"GET",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass}});if(!a.ok)throw new Error("ارتباط با API پزشک ناموفق بود");return await a.json()}(e,d);let k="-",B="-";w.success&&(p=w.data.codeTakh,g=w.data.codetakh2,k=w.data.nameDoctor,B=w.data.takhasos);const D={ReqNum:n,RegDate:r,ReqDate:i,NationalCode:a,DocID:d,idNoskhe:l,trackingcode:n,Radifs:c};console.log(D);const T=await async function(e,t){const n=await fetch(`${e.API_URL}api/esata/SelectKala`,{method:"POST",headers:{"X-Db-Server":e.Server,"X-Db-Name":e.DataBase,"X-Db-User":e.username,"X-Db-Pass":e.pass,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error("دریافت کالاها از API ناموفق بود");return await n.json()}(e,D);m({ReqNum:n,bimarname:o,NationalCode:a,NameDrAria:k,Takhasos:B,NezamDr:d,datefac:r,DateNoskhe:i,codetakh:p,codetakhsend2:g,trackingCode:E,isManfi:u,CoName:v,id:b,Lname:y,Hname:f,Server:e.Server,DataBase:e.DataBase,username:e.username,pass:e.pass,APIURL:e.API_URL,Radifs:T.data||[]})}(w)}else alert("⚠️نام کاربری یا رمز ورود اشتباه میباشد⚠️"),n.disabled=!1,a.disabled=!1;return k}alert("نام کاربری و رمز خود را وارد کنید"),n.disabled=!1,a.disabled=!1}),chrome.runtime.sendMessage({action:"readConfig"},e=>{if(e?.config){const t=e.config;w=t,document.getElementById("uidaria").value=t.username||null,document.getElementById("pidaria").value=t.pass||null,document.getElementById("servernamearia").value=t.Server,document.getElementById("databasenamearia").value=t.DataBase,I=document.getElementById("uidaria").value,document.getElementById("uidaria").value="*".repeat(I.length),E=document.getElementById("pidaria").value,document.getElementById("pidaria").value="*".repeat(E.length)}else console.error("خطا در دریافت تنظیمات:",e?.error||e)});const d=document.getElementById("uidaria");d.addEventListener("input",e=>{const t=e.data,n=d.value.length;n<I.length?I=I.slice(0,n):null!==t&&(I+=t),d.value="*".repeat(I.length)}),d.addEventListener("copy",e=>{e.preventDefault()});const r=document.getElementById("pidaria");r.addEventListener("input",e=>{const t=e.data,n=r.value.length;n<E.length?E=E.slice(0,n):null!==t&&(E+=t),r.value="*".repeat(E.length)}),r.addEventListener("copy",e=>{e.preventDefault()})}()}catch(e){console.error("❌ خطا در فرآیند افزونه:",e.message),alert("❌ خطا در اجرا. جزئیات در کنسول.")}finally{e.disabled=!1}})}();let w=[],k=[]})();